<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Mi Cat√°logo</title>

<!-- Open Graph - vista previa al compartir en WhatsApp, Facebook, etc -->
<meta property="og:type" content="website"/>
<meta property="og:title" content="Mi Cat√°logo"/>
<meta property="og:description" content="Lentes, accesorios y m√°s. Local A-20, Tianguis H√©ctor Espino, Hermosillo Sonora."/>
<meta property="og:image" content="https://ofertashermosillo.github.io/curly-funicular/preview.png"/>
<meta property="og:url" content="https://ofertashermosillo.github.io/curly-funicular/"/>
<meta property="og:site_name" content="Mi Cat√°logo"/>

<!-- WhatsApp usa estas -->
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:title" content="Mi Cat√°logo"/>
<meta name="twitter:description" content="Lentes, accesorios y m√°s. Local A-20, Tianguis H√©ctor Espino, Hermosillo Sonora."/>
<meta name="twitter:image" content="https://ofertashermosillo.github.io/curly-funicular/preview.png"/>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet"/>
<style>
:root{--bg:#0f0f0f;--surface:#1a1a1a;--card:#242424;--accent:#25D366;--accent2:#e8c97e;--text:#f0f0f0;--muted:#888;--border:#333;--radius:14px;}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}

/* LOADING */
#loading{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:999;gap:16px;}
.spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--accent2);border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}

/* VIEWS */
.view{display:none;}
.view.active{display:block;}

/* HEADER */
header{background:var(--surface);border-bottom:1px solid var(--border);padding:14px 20px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;}
.logo{font-family:'Playfair Display',serif;font-size:20px;color:var(--accent2);cursor:pointer;}
.btn-admin{background:transparent;color:var(--border);border:1px solid var(--border);padding:5px 10px;border-radius:8px;cursor:pointer;font-size:11px;opacity:.4;}
.btn-admin:hover{opacity:1;color:var(--accent2);border-color:var(--accent2);}
.btn-back{background:none;border:none;color:var(--accent2);font-size:15px;cursor:pointer;display:flex;align-items:center;gap:6px;font-family:'DM Sans',sans-serif;font-weight:600;}
.btn-cat{background:#1877F2;color:#fff;border:none;padding:7px 14px;border-radius:20px;font-size:12px;font-weight:700;cursor:pointer;font-family:'DM Sans',sans-serif;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}

/* CAT NAV */
.cat-nav{display:flex;gap:8px;padding:12px 20px;overflow-x:auto;background:var(--surface);border-bottom:1px solid var(--border);scrollbar-width:none;}
.cat-nav::-webkit-scrollbar{display:none;}
.cat-btn{white-space:nowrap;padding:7px 16px;border-radius:20px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;font-size:13px;font-family:'DM Sans',sans-serif;transition:all .2s;}
.cat-btn.active,.cat-btn:hover{background:var(--accent);color:#000;border-color:var(--accent);font-weight:600;}
.cat-share{background:none;border:none;color:var(--muted);cursor:pointer;font-size:14px;padding:2px 3px;vertical-align:middle;}

/* GRID */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:14px;padding:16px;}
@media(min-width:600px){.grid{grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:20px;padding:20px;}}

/* CARD */
.card{background:var(--card);border-radius:var(--radius);overflow:hidden;border:1px solid var(--border);cursor:pointer;transition:transform .2s,box-shadow .2s;}
.card:hover{transform:translateY(-3px);box-shadow:0 8px 30px rgba(0,0,0,.4);}
.card-thumb{aspect-ratio:1/1;overflow:hidden;background:#111;}
.card-thumb img{width:100%;height:100%;object-fit:cover;}
.card-thumb .no-img-sm{width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:36px;color:var(--muted);}
.card-info{padding:10px 12px 12px;}
.card-category{font-size:10px;color:var(--accent2);text-transform:uppercase;letter-spacing:.08em;font-weight:600;margin-bottom:3px;}
.card-name{font-family:'Playfair Display',serif;font-size:14px;line-height:1.3;margin-bottom:4px;}
.card-price{font-size:16px;font-weight:700;color:var(--accent2);}

/* PRODUCT DETAIL VIEW */
#detailView header{position:sticky;top:0;}
.detail-carousel{position:relative;background:#111;width:100%;}
.detail-imgs{display:flex;transition:transform .35s ease;}
.detail-imgs img{min-width:100%;width:100%;max-height:380px;object-fit:contain;flex-shrink:0;background:#111;}
.detail-imgs .no-img-lg{min-width:100%;height:280px;display:flex;align-items:center;justify-content:center;font-size:64px;color:var(--muted);}
.d-prev,.d-next{position:absolute;top:50%;transform:translateY(-50%);background:rgba(0,0,0,.6);color:#fff;border:none;width:38px;height:38px;border-radius:50%;cursor:pointer;font-size:22px;display:flex;align-items:center;justify-content:center;}
.d-prev{left:10px;}.d-next{right:10px;}
.d-dots{display:flex;justify-content:center;gap:6px;padding:10px;}
.d-dot{width:8px;height:8px;border-radius:50%;background:var(--border);cursor:pointer;}
.d-dot.active{background:var(--accent2);}
.detail-thumbnails{display:flex;gap:8px;padding:0 16px 12px;overflow-x:auto;scrollbar-width:none;}
.detail-thumbnails::-webkit-scrollbar{display:none;}
.d-thumb{width:60px;height:60px;border-radius:8px;overflow:hidden;cursor:pointer;border:2px solid transparent;flex-shrink:0;}
.d-thumb.active{border-color:var(--accent2);}
.d-thumb img{width:100%;height:100%;object-fit:cover;}
.detail-body{padding:16px 20px 24px;}
.detail-cat{font-size:11px;color:var(--accent2);text-transform:uppercase;letter-spacing:.08em;font-weight:600;margin-bottom:6px;cursor:pointer;display:inline-block;border-bottom:1px solid transparent;}
.detail-cat:hover{border-bottom-color:var(--accent2);}
.detail-name{font-family:'Playfair Display',serif;font-size:24px;line-height:1.2;margin-bottom:8px;}
.detail-price{font-size:28px;font-weight:700;color:var(--accent2);margin-bottom:14px;}
.detail-desc{font-size:14px;color:var(--muted);line-height:1.7;margin-bottom:24px;white-space:pre-wrap;}
.detail-actions{display:flex;gap:10px;padding:14px 16px;border-bottom:1px solid var(--border);}
.btn-wa-lg{flex:1;background:var(--accent);color:#000;border:none;padding:15px;border-radius:12px;font-weight:700;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;gap:8px;font-family:'DM Sans',sans-serif;box-shadow:0 4px 20px rgba(37,211,102,.4);}
.btn-wa-lg:hover{opacity:.85;}
.btn-share-lg{background:var(--surface);border:1px solid var(--border);color:var(--text);padding:15px 18px;border-radius:12px;cursor:pointer;font-size:18px;}

/* MODALS */
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:200;align-items:flex-start;justify-content:center;padding:20px;overflow-y:auto;}
.overlay.open{display:flex;}
.modal{background:var(--surface);border-radius:var(--radius);width:100%;max-width:520px;padding:24px;border:1px solid var(--border);margin:auto;}
.modal h2{font-family:'Playfair Display',serif;margin-bottom:18px;color:var(--accent2);}
label{display:block;font-size:13px;color:var(--muted);margin-bottom:5px;margin-top:14px;}
input[type=text],input[type=number],input[type=password],textarea,select{width:100%;background:var(--card);border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:8px;font-size:14px;font-family:'DM Sans',sans-serif;}
input:focus,textarea:focus,select:focus{outline:1px solid var(--accent2);}
textarea{resize:vertical;min-height:80px;}
.img-upload-area{border:2px dashed var(--border);border-radius:10px;padding:20px;text-align:center;cursor:pointer;margin-top:8px;}
.img-upload-area:hover{border-color:var(--accent2);}
.img-upload-area input{display:none;}
.img-previews{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;}
.img-thumb{position:relative;width:70px;height:70px;border-radius:8px;overflow:hidden;}
.img-thumb img{width:100%;height:100%;object-fit:cover;}
.del-img{position:absolute;top:2px;right:2px;background:rgba(0,0,0,.7);color:#fff;border:none;border-radius:50%;width:20px;height:20px;cursor:pointer;font-size:12px;}
.modal-actions{display:flex;gap:10px;margin-top:20px;}
.btn-save{flex:1;background:var(--accent);color:#000;border:none;padding:12px;border-radius:9px;font-weight:700;cursor:pointer;font-size:14px;}
.btn-cancel{background:var(--card);border:1px solid var(--border);color:var(--text);padding:12px 16px;border-radius:9px;cursor:pointer;font-size:14px;}
.btn-del-prod{background:#c0392b;color:#fff;border:none;padding:12px 16px;border-radius:9px;cursor:pointer;font-size:14px;}
.prod-list{margin-top:10px;max-height:200px;overflow-y:auto;}
.prod-item{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;cursor:pointer;border:1px solid transparent;}
.prod-item:hover{background:var(--card);border-color:var(--border);}
.prod-item img{width:42px;height:42px;object-fit:cover;border-radius:6px;background:#111;}
.prod-item-info{flex:1;}
.prod-item-info strong{font-size:13px;display:block;}
.prod-item-info span{font-size:11px;color:var(--muted);}
hr{border:none;border-top:1px solid var(--border);margin-top:18px;}
#passOverlay{position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:300;display:none;align-items:center;justify-content:center;padding:20px;}
#passOverlay.open{display:flex;}
.pass-box{background:var(--surface);border-radius:var(--radius);padding:28px;width:100%;max-width:300px;border:1px solid var(--border);text-align:center;}
.pass-box h3{font-family:'Playfair Display',serif;color:var(--accent2);margin-bottom:16px;}
.pass-error{color:#e74c3c;font-size:12px;margin-top:6px;display:none;}
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--accent);color:#000;padding:10px 22px;border-radius:20px;font-weight:600;font-size:13px;z-index:999;transition:transform .3s;pointer-events:none;}
.toast.show{transform:translateX(-50%) translateY(0);}
.empty{text-align:center;padding:60px 20px;color:var(--muted);}
.related-section{padding:20px;}
.related-title{font-family:'Playfair Display',serif;font-size:17px;color:var(--accent2);margin-bottom:14px;}
.related-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.related-card{background:var(--card);border-radius:var(--radius);overflow:hidden;border:1px solid var(--border);cursor:pointer;transition:transform .2s;}
.related-card:hover{transform:translateY(-2px);}
.related-card-thumb{aspect-ratio:1/1;overflow:hidden;background:#111;}
.related-card-thumb img{width:100%;height:100%;object-fit:cover;}
.related-card-thumb .no-img-rel{width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:28px;color:var(--muted);}
.related-card-info{padding:8px 10px 10px;}
.related-card-name{font-size:13px;font-weight:600;line-height:1.3;margin-bottom:3px;}
.related-card-price{font-size:14px;font-weight:700;color:var(--accent2);}
.site-footer{background:var(--surface);border-top:1px solid var(--border);padding:24px 20px;text-align:center;color:var(--muted);font-size:13px;line-height:1.8;}
.site-footer strong{color:var(--accent2);font-size:14px;display:block;margin-bottom:6px;}
.site-footer a{color:var(--accent);text-decoration:none;}
.empty span{font-size:48px;display:block;margin-bottom:12px;}

/* ORDER MODAL */
#orderOverlay{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:400;display:none;align-items:flex-end;justify-content:center;}
#orderOverlay.open{display:flex;}
.order-box{background:var(--surface);border-radius:20px 20px 0 0;width:100%;max-width:520px;padding:24px 20px 32px;border-top:1px solid var(--border);}
.order-box h3{font-family:'Playfair Display',serif;color:var(--accent2);margin-bottom:6px;font-size:18px;}
.order-box p{font-size:13px;color:var(--muted);margin-bottom:18px;}
.order-box input{width:100%;background:var(--card);border:1px solid var(--border);color:var(--text);padding:12px 14px;border-radius:10px;font-size:15px;font-family:'DM Sans',sans-serif;margin-bottom:12px;}
.order-box input:focus{outline:1px solid var(--accent2);}
.btn-wa-send{width:100%;background:var(--accent);color:#000;border:none;padding:15px;border-radius:12px;font-weight:700;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;gap:8px;font-family:'DM Sans',sans-serif;box-shadow:0 4px 20px rgba(37,211,102,.4);}
.btn-wa-cancel{width:100%;background:transparent;border:none;color:var(--muted);padding:10px;cursor:pointer;font-size:14px;margin-top:8px;}
</style>
</head>
<body>

<div id="loading"><div class="spinner"></div><p style="color:var(--muted);font-size:14px">Cargando...</p></div>

<!-- CATALOG VIEW -->
<div id="catalogView" class="view">
  <header>
    <div class="logo" id="shopName" onclick="goHome()">Mi Tienda</div>
    <button class="btn-admin" onclick="askPass()">‚öô</button>
  </header>
  <div class="cat-nav" id="catNav"></div>
  <div class="grid" id="grid"></div>
  <footer class="site-footer">
    <strong>üìç ¬øD√≥nde encontrarnos?</strong>
    Local A-20, Tianguis H√©ctor Espino<br>
    Col. Pimentel, C.P. 83188<br>
    Hermosillo, Sonora<br>
    <a href="https://api.whatsapp.com/send?phone=526623467676">üì± +52 662 346 7676</a>
  </footer>
</div>

<!-- DETAIL VIEW -->
<div id="detailView" class="view">
  <header>
    <button class="btn-back" onclick="goHome()">‚Üê Volver</button>
    <div style="display:flex;align-items:center;gap:8px">
      <button class="btn-cat" id="btnCatFilter" onclick="goCat()"></button>
      <button class="btn-admin" onclick="askPass()">‚öô</button>
    </div>
  </header>
  <div id="detailContent"></div>
  <footer class="site-footer">
    <strong>üìç ¬øD√≥nde encontrarnos?</strong>
    Local A-20, Tianguis H√©ctor Espino<br>
    Col. Pimentel, C.P. 83188<br>
    Hermosillo, Sonora<br>
    <a href="https://api.whatsapp.com/send?phone=526623467676">üì± +52 662 346 7676</a>
  </footer>
</div>

<!-- PASSWORD MODAL -->
<div id="passOverlay">
  <div class="pass-box">
    <h3>üîí Admin</h3>
    <input type="password" id="passInput" placeholder="Contrase√±a..." onkeydown="if(event.key==='Enter')checkPass()"/>
    <p class="pass-error" id="passError">Contrase√±a incorrecta</p>
    <div style="display:flex;gap:8px;margin-top:14px">
      <button class="btn-cancel" onclick="closePass()">Cancelar</button>
      <button class="btn-save" onclick="checkPass()">Entrar</button>
    </div>
  </div>
</div>

<!-- ADMIN MODAL -->
<div class="overlay" id="adminOverlay">
  <div class="modal">
    <h2>‚öô Administraci√≥n</h2>
    <label>Nombre de tu tienda</label>
    <input type="text" id="shopNameInput"/>
    <label>WhatsApp Business (solo n√∫meros con c√≥digo de pa√≠s)</label>
    <input type="text" id="waNumber" placeholder="5216621234567" oninput="this.value=this.value.replace(/\D/g,'')"/>
    <small style="color:var(--muted);font-size:11px;margin-top:4px;display:block">M√©xico: 52 + 10 d√≠gitos. Ej: 5216621234567</small>
    <label>Contrase√±a de administrador</label>
    <input type="password" id="adminPass"/>
    <hr/>
    <h3 style="margin-top:16px;font-size:15px;color:var(--accent2)">Categor√≠as</h3>
    <div style="display:flex;gap:8px;margin-top:10px">
      <input type="text" id="newCatInput" placeholder="Nueva categor√≠a..." style="flex:1"/>
      <button class="btn-save" style="flex:none;padding:10px 14px" onclick="addCategory()">+</button>
    </div>
    <div id="catListAdmin" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:10px"></div>
    <hr/>
    <h3 style="margin-top:16px;font-size:15px;color:var(--accent2)">Productos</h3>
    <div class="prod-list" id="prodList"></div>
    <button class="btn-save" style="margin-top:12px;width:100%" onclick="openProductForm()">+ Nuevo producto</button>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeAdmin()">Cerrar</button>
      <button class="btn-save" onclick="saveConfig()">üíæ Guardar</button>
    </div>
  </div>
</div>

<!-- PRODUCT FORM MODAL -->
<div class="overlay" id="productOverlay">
  <div class="modal">
    <h2 id="formTitle">Nuevo Producto</h2>
    <label>Nombre *</label>
    <input type="text" id="pName"/>
    <label>Precio *</label>
    <input type="number" id="pPrice"/>
    <label>Descripci√≥n</label>
    <textarea id="pDesc" placeholder="Describe el producto..."></textarea>
    <label>Categor√≠a</label>
    <select id="pCat"></select>
    <label>Fotos</label>
    <div class="img-upload-area" onclick="document.getElementById('imgInput').click()">
      <input type="file" id="imgInput" accept="image/*" multiple onchange="handleImages(event)"/>
      <span style="font-size:28px">üì∑</span>
      <p style="font-size:13px;color:var(--muted);margin-top:6px">Toca para elegir fotos de tu dispositivo</p>
    </div>
    <div class="img-previews" id="imgPreviews"></div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeProductForm()">Cancelar</button>
      <button class="btn-del-prod" id="btnDelete" style="display:none" onclick="deleteProduct()">Eliminar</button>
      <button class="btn-save" onclick="saveProduct()">üíæ Guardar</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
const firebaseConfig = {
  apiKey:"AIzaSyD7wqv1_4Fq7lIZfgpj8X1Mg4qs5X5DZEY",
  authDomain:"ofertashmo-bef92.firebaseapp.com",
  databaseURL:"https://ofertashmo-bef92-default-rtdb.firebaseio.com",
  projectId:"ofertashmo-bef92",
  storageBucket:"ofertashmo-bef92.firebasestorage.app",
  messagingSenderId:"249407262256",
  appId:"1:249407262256:web:d3a5f9bade9a85f55667f5"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
window._fbSet = (path,data) => set(ref(db,path),data);
window._fbGet = (path) => get(ref(db,path));

async function init(){
  try{
    const snap = await window._fbGet('/');
    if(snap.exists()){
      const d = snap.val();
      if(d.config) window._cfg = {...window._cfg,...d.config};
      if(d.products) window._prods = Object.values(d.products);
    }
  }catch(e){console.error(e);}
  document.getElementById('loading').style.display='none';
  document.getElementById('shopName').textContent = window._cfg.shopName||'Mi Tienda';
  handleHash();
}
init();
</script>

<script>
window._cfg = {shopName:'Mi Tienda',waNumber:'',categories:[],adminPass:'1234'};
window._prods = [];
let currentCat='all', currentImages=[], editingId=null;
const dSlideIdx={};

function cleanWA(n){return (n||'').replace(/\D/g,'');}
function buildWAUrl(name,price){
  const num=cleanWA(window._cfg.waNumber);
  const msg=encodeURIComponent(`Hola! Me interesa: *${name}* - $${price}\n¬øEst√° disponible?`);
  return `https://api.whatsapp.com/send?phone=${num}&text=${msg}`;
}
async function fbSave(){
  const obj={};
  window._prods.forEach(p=>{obj[p.id]=p;});
  await window._fbSet('/config',window._cfg);
  await window._fbSet('/products',obj);
}

// ROUTING via hash
function handleHash(){
  const h = location.hash;
  if(h.startsWith('#prod=')){
    const id=h.slice(6);
    const p=window._prods.find(x=>x.id===id);
    if(p) showDetail(p,false);
    else showCatalog();
  } else if(h.startsWith('#cat=')){
    currentCat=decodeURIComponent(h.slice(5));
    showCatalog();
  } else {
    currentCat='all';
    showCatalog();
  }
}

function showCatalog(){
  document.getElementById('catalogView').classList.add('active');
  document.getElementById('detailView').classList.remove('active');
  renderCatNav();
  renderGrid();
}

function goHome(){
  currentCat='all';
  location.hash='';
  showCatalog();
}

// CATALOG
function renderCatNav(){
  const nav=document.getElementById('catNav'); nav.innerHTML='';
  const all=document.createElement('button');
  all.className='cat-btn'+(currentCat==='all'?' active':'');
  all.textContent='Todos';
  all.onclick=()=>{currentCat='all';location.hash='';renderGrid();renderCatNav();};
  nav.appendChild(all);
  (window._cfg.categories||[]).forEach(cat=>{
    const wrap=document.createElement('span');
    wrap.style.display='inline-flex';wrap.style.alignItems='center';
    const btn=document.createElement('button');
    btn.className='cat-btn'+(currentCat===cat?' active':'');
    btn.textContent=cat;
    btn.onclick=()=>{currentCat=cat;location.hash='#cat='+encodeURIComponent(cat);renderGrid();renderCatNav();};
    const sh=document.createElement('button');
    sh.className='cat-share';sh.innerHTML='üîó';sh.title='Compartir categor√≠a';
    sh.onclick=e=>{e.stopPropagation();shareLink('cat',cat);};
    wrap.appendChild(btn);wrap.appendChild(sh);nav.appendChild(wrap);
  });
}

function renderGrid(){
  const grid=document.getElementById('grid');
  const list=currentCat==='all'?window._prods:window._prods.filter(p=>p.cat===currentCat);
  if(!list.length){grid.innerHTML='<div class="empty"><span>üõç</span>No hay productos a√∫n.<br>Usa ‚öô para agregar.</div>';return;}
  grid.innerHTML='';
  list.forEach(p=>{
    const card=document.createElement('div');
    card.className='card';
    const img=(p.images||[])[0];
    card.innerHTML=`
      <div class="card-thumb">${img?`<img src="${img}" loading="lazy"/>`:'<div class="no-img-sm">üì¶</div>'}</div>
      <div class="card-info">
        <div class="card-category">${p.cat||''}</div>
        <div class="card-name">${p.name}</div>
        <div class="card-price">$${Number(p.price).toLocaleString()}</div>
      </div>`;
    card.onclick=()=>{location.hash='#prod='+p.id;showDetail(p,true);};
    grid.appendChild(card);
  });
}

// DETAIL
function showDetail(p, pushHistory){
  document.getElementById('catalogView').classList.remove('active');
  document.getElementById('detailView').classList.add('active');
  const imgs=p.images||[];
  dSlideIdx[p.id]=0;

  let carouselHTML='';
  if(!imgs.length){
    carouselHTML=`<div class="detail-carousel"><div class="detail-imgs"><div class="no-img-lg">üì¶</div></div></div>`;
  } else {
    const arrows=imgs.length>1?`<button class="d-prev" onclick="dGoSlide('${p.id}',-1)">&#8249;</button><button class="d-next" onclick="dGoSlide('${p.id}',1)">&#8250;</button>`:'';
    const dots=imgs.length>1?`<div class="d-dots">${imgs.map((_,i)=>`<div class="d-dot${i===0?' active':''}" id="ddot-${p.id}-${i}" onclick="dSetSlide('${p.id}',${i})"></div>`).join('')}</div>`:'';
    const thumbs=imgs.length>1?`<div class="detail-thumbnails">${imgs.map((s,i)=>`<div class="d-thumb${i===0?' active':''}" id="dthumb-${p.id}-${i}" onclick="dSetSlide('${p.id}',${i})"><img src="${s}"/></div>`).join('')}</div>`:'';
    carouselHTML=`<div class="detail-carousel">
      <div class="detail-imgs" id="dimgs-${p.id}">${imgs.map(s=>`<img src="${s}"/>`).join('')}</div>
      ${arrows}${dots}
    </div>${thumbs}`;
  }

  const waUrl=buildWAUrl(p.name,p.price);
  // Set category button text
  window._currentDetailProd = p;
  setTimeout(()=>{
    if(imgs.length > 1) initCarouselTouch(p.id);
    const btn=document.getElementById('btnCatFilter');
    if(btn && p.cat){ btn.textContent='Ver m√°s: '+p.cat; btn.style.display='inline-block'; }
    else if(btn){ btn.style.display='none'; }
  },0);
  document.getElementById('detailContent').innerHTML=`
    ${carouselHTML}
    <div class="detail-actions">
        <button class="btn-wa-lg" onclick="window.open('${waUrl}','_blank')">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
          Pedir por WhatsApp
        </button>
        <button class="btn-share-lg" onclick="shareLink('prod','${p.id}')">üîó</button>
      </div>
    <div class="detail-body">
      <div class="detail-cat" onclick="goCat()" title="Ver m√°s de esta categor√≠a">${p.cat ? '‚ñ∏ '+p.cat : ''}</div>
      <div class="detail-name">${p.name}</div>
      <div class="detail-price">$${Number(p.price).toLocaleString()}</div>
      <div class="detail-desc">${p.desc||''}</div>
    </div>
    ${buildRelated(p)}`;
}

function dSetSlide(id,i){
  dSlideIdx[id]=i;
  const el=document.getElementById('dimgs-'+id);
  if(el) el.style.transform=`translateX(-${i*100}%)`;
  const p=window._prods.find(x=>x.id===id);
  const total=(p?.images||[]).length;
  for(let j=0;j<total;j++){
    const dot=document.getElementById(`ddot-${id}-${j}`);
    const thumb=document.getElementById(`dthumb-${id}-${j}`);
    if(dot) dot.classList.toggle('active',j===i);
    if(thumb) thumb.classList.toggle('active',j===i);
  }
}
function dGoSlide(id,dir){
  const p=window._prods.find(x=>x.id===id);
  const total=(p?.images||[]).length;
  const cur=dSlideIdx[id]||0;
  dSetSlide(id,(cur+dir+total)%total);
}

// Touch swipe support for detail carousel
function initCarouselTouch(id){
  const el = document.getElementById('dimgs-'+id);
  if(!el) return;
  let startX=0, startY=0, isDragging=false;

  el.addEventListener('touchstart', e=>{
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
    isDragging = true;
  }, {passive:true});

  el.addEventListener('touchmove', e=>{
    if(!isDragging) return;
    const dx = e.touches[0].clientX - startX;
    const dy = e.touches[0].clientY - startY;
    // If horizontal swipe is dominant, prevent page scroll
    if(Math.abs(dx) > Math.abs(dy)){
      e.preventDefault();
    }
  }, {passive:false});

  el.addEventListener('touchend', e=>{
    if(!isDragging) return;
    isDragging = false;
    const dx = e.changedTouches[0].clientX - startX;
    const dy = e.changedTouches[0].clientY - startY;
    if(Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 40){
      dGoSlide(id, dx < 0 ? 1 : -1);
    }
  }, {passive:true});
}

// SHARE - using hash which works on GitHub Pages
function shareLink(type,val){
  let url=location.origin+location.pathname;
  url+=type==='cat'?'#cat='+encodeURIComponent(val):'#prod='+val;
  if(navigator.share){navigator.share({url}).catch(()=>{});}
  else{navigator.clipboard.writeText(url).then(()=>showToast('¬°Link copiado!')).catch(()=>prompt('Copia este link:',url));}
}

// PASSWORD
function askPass(){
  document.getElementById('passInput').value='';
  document.getElementById('passError').style.display='none';
  document.getElementById('passOverlay').classList.add('open');
  setTimeout(()=>document.getElementById('passInput').focus(),200);
}
function closePass(){document.getElementById('passOverlay').classList.remove('open');}
function checkPass(){
  const v=document.getElementById('passInput').value;
  if(v===(window._cfg.adminPass||'1234')){closePass();openAdmin();}
  else{document.getElementById('passError').style.display='block';document.getElementById('passInput').value='';}
}

// ADMIN
function openAdmin(){
  document.getElementById('shopNameInput').value=window._cfg.shopName||'';
  document.getElementById('waNumber').value=window._cfg.waNumber||'';
  document.getElementById('adminPass').value=window._cfg.adminPass||'1234';
  renderCatListAdmin();renderProdList();
  document.getElementById('adminOverlay').classList.add('open');
}
function closeAdmin(){document.getElementById('adminOverlay').classList.remove('open');}
function renderCatListAdmin(){
  const el=document.getElementById('catListAdmin');el.innerHTML='';
  (window._cfg.categories||[]).forEach(cat=>{
    const s=document.createElement('span');
    s.style.cssText='background:var(--card);border:1px solid var(--border);border-radius:16px;padding:4px 10px;font-size:12px;display:inline-flex;align-items:center;gap:6px;margin-bottom:4px;';
    s.innerHTML=`${cat} <button onclick="removeCategory('${cat}')" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:16px">√ó</button>`;
    el.appendChild(s);
  });
}
function addCategory(){
  const v=document.getElementById('newCatInput').value.trim();if(!v)return;
  if(!(window._cfg.categories||[]).includes(v))window._cfg.categories=[...(window._cfg.categories||[]),v];
  document.getElementById('newCatInput').value='';
  renderCatListAdmin();renderCatSelect();
}
function removeCategory(cat){
  window._cfg.categories=(window._cfg.categories||[]).filter(c=>c!==cat);
  renderCatListAdmin();renderCatSelect();
}
function renderProdList(){
  const el=document.getElementById('prodList');el.innerHTML='';
  if(!window._prods.length){el.innerHTML='<p style="color:var(--muted);font-size:13px;padding:8px">Sin productos.</p>';return;}
  window._prods.forEach(p=>{
    const item=document.createElement('div');item.className='prod-item';
    item.innerHTML=`<img src="${(p.images||[])[0]||''}" onerror="this.style.display='none'"/><div class="prod-item-info"><strong>${p.name}</strong><span>$${p.price} ¬∑ ${p.cat||'Sin cat.'}</span></div><span style="color:var(--muted)">‚úè</span>`;
    item.onclick=()=>openProductForm(p.id);
    el.appendChild(item);
  });
}
async function saveConfig(){
  const pass=document.getElementById('adminPass').value.trim();
  if(!pass){showToast('Pon una contrase√±a');return;}
  window._cfg.shopName=document.getElementById('shopNameInput').value.trim()||'Mi Tienda';
  window._cfg.waNumber=cleanWA(document.getElementById('waNumber').value);
  window._cfg.adminPass=pass;
  document.getElementById('shopName').textContent=window._cfg.shopName;
  showToast('Guardando...');
  await fbSave();
  showToast('¬°Guardado! ‚úì');
  renderCatNav();
}

// PRODUCT FORM
function renderCatSelect(){
  const sel=document.getElementById('pCat');
  sel.innerHTML='<option value="">Sin categor√≠a</option>';
  (window._cfg.categories||[]).forEach(c=>{sel.innerHTML+=`<option value="${c}">${c}</option>`;});
}
function openProductForm(id=null){
  editingId=id;currentImages=[];
  renderCatSelect();
  document.getElementById('formTitle').textContent=id?'Editar Producto':'Nuevo Producto';
  document.getElementById('btnDelete').style.display=id?'inline-block':'none';
  if(id){
    const p=window._prods.find(x=>x.id===id);
    document.getElementById('pName').value=p.name||'';
    document.getElementById('pPrice').value=p.price||'';
    document.getElementById('pDesc').value=p.desc||'';
    document.getElementById('pCat').value=p.cat||'';
    currentImages=[...(p.images||[])];
  } else {
    ['pName','pPrice','pDesc'].forEach(i=>document.getElementById(i).value='');
    document.getElementById('pCat').value='';
  }
  renderImgPreviews();
  document.getElementById('productOverlay').classList.add('open');
}
function closeProductForm(){document.getElementById('productOverlay').classList.remove('open');}
function handleImages(e){
  Array.from(e.target.files).forEach(f=>{
    if(currentImages.length>=8){showToast('M√°ximo 8 fotos');return;}
    const reader=new FileReader();
    reader.onload=ev=>{
      const img=new Image();
      img.onload=()=>{
        const canvas=document.createElement('canvas');
        const max=800;let w=img.width,h=img.height;
        if(w>max||h>max){if(w>h){h=Math.round(h*max/w);w=max;}else{w=Math.round(w*max/h);h=max;}}
        canvas.width=w;canvas.height=h;
        canvas.getContext('2d').drawImage(img,0,0,w,h);
        currentImages.push(canvas.toDataURL('image/jpeg',0.78));
        renderImgPreviews();
      };
      img.src=ev.target.result;
    };
    reader.readAsDataURL(f);
  });
  e.target.value='';
}
function renderImgPreviews(){
  const el=document.getElementById('imgPreviews');el.innerHTML='';
  currentImages.forEach((src,i)=>{
    const d=document.createElement('div');d.className='img-thumb';
    d.innerHTML=`<img src="${src}"/><button class="del-img" onclick="removeImg(${i})">√ó</button>`;
    el.appendChild(d);
  });
}
function removeImg(i){currentImages.splice(i,1);renderImgPreviews();}
async function saveProduct(){
  const name=document.getElementById('pName').value.trim();
  const price=document.getElementById('pPrice').value;
  if(!name||!price){showToast('Nombre y precio requeridos');return;}
  showToast('Guardando...');
  const prod={id:editingId||'p'+Date.now(),name,price,desc:document.getElementById('pDesc').value.trim(),cat:document.getElementById('pCat').value,images:currentImages};
  if(editingId){const idx=window._prods.findIndex(p=>p.id===editingId);window._prods[idx]=prod;}
  else{window._prods.push(prod);}
  await fbSave();
  closeProductForm();renderProdList();
  showCatalog();
  showToast(editingId?'¬°Actualizado! ‚úì':'¬°Agregado! ‚úì');
}
async function deleteProduct(){
  if(!confirm('¬øEliminar este producto?'))return;
  window._prods=window._prods.filter(p=>p.id!==editingId);
  await fbSave();
  closeProductForm();renderProdList();
  showCatalog();
  showToast('Eliminado');
}

function openRelated(id){
  const p=window._prods.find(x=>x.id===id);
  if(!p) return;
  location.hash='#prod='+id;
  showDetail(p,true);
  window.scrollTo(0,0);
}

function buildRelated(p){
  if(!p.cat) return '';
  const related = window._prods.filter(x=>x.id!==p.id && x.cat===p.cat).slice(0,4);
  if(!related.length) return '';
  const cards = related.map(r=>{
    const img=(r.images||[])[0];
    const thumb = img ? `<img src="${img}" loading="lazy"/>` : '<div class="no-img-rel">üì¶</div>';
    return '<div class="related-card" onclick="openRelated(\'' + r.id + '\')">'
      + '<div class="related-card-thumb">' + thumb + '</div>'
      + '<div class="related-card-info">'
      + '<div class="related-card-name">' + r.name + '</div>'
      + '<div class="related-card-price">$' + Number(r.price).toLocaleString() + '</div>'
      + '</div></div>';
  }).join('');
  return `<div class="related-section">
    <div class="related-title">M√°s ${p.cat}</div>
    <div class="related-grid">${cards}</div>
  </div>`;
}

function goCat(){
  const p = window._currentDetailProd;
  if(!p || !p.cat) return;
  currentCat = p.cat;
  location.hash = '#cat='+encodeURIComponent(p.cat);
  showCatalog();
}

function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2500);
}

window.onhashchange=handleHash;

Object.assign(window,{goHome,goCat,openRelated,closeOrder,sendOrderWA,askPass,closePass,checkPass,openAdmin,closeAdmin,addCategory,removeCategory,saveConfig,openProductForm,closeProductForm,handleImages,removeImg,saveProduct,deleteProduct,dGoSlide,dSetSlide,shareLink});
</script>

<!-- ORDER MODAL -->
<div id="orderOverlay">
  <div class="order-box">
    <h3>üì¶ ¬øA d√≥nde te lo llevamos?</h3>
    <p>D√©janos tus datos para completar tu pedido</p>
    <input type="text" id="orderName" placeholder="Tu nombre completo" maxlength="60"/>
    <input type="text" id="orderColonia" placeholder="Tu colonia" maxlength="80"/>
    <input type="text" id="orderCalle" placeholder="Calle y n√∫mero (opcional)" maxlength="100"/>
    <button class="btn-wa-send" onclick="sendOrderWA()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
      Enviar pedido por WhatsApp
    </button>
    <button class="btn-wa-cancel" onclick="closeOrder()">Cancelar</button>
  </div>
</div>
</body>
</html>
